
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Classification Test - AI Curation Engine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .result-card { margin: 10px 0; }
        .score-badge { font-size: 0.9em; margin: 2px; }
        .loading { display: none; }
        .recommendation-allow { background-color: #d4edda; border-color: #c3e6cb; }
        .recommendation-caution { background-color: #fff3cd; border-color: #ffeaa7; }
        .recommendation-block { background-color: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>AI Curation Engine
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-search me-2"></i>Content Classification Test</h2>
                <p class="text-muted">Test the AI-powered content classification system with real BAML integration</p>
            </div>
        </div>

        <!-- Strategy Control Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Curation Engine Strategy Control</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Active Strategy:</label>
                                <select class="form-select" id="strategySelect">
                                    <option value="hybrid">üîÑ Hybrid (Smart)</option>
                                    <option value="multi_layer">üè≠ Multi-Layer (Fast)</option>
                                    <option value="llm_only">üß† LLM-Only (Detailed)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Strategy Description:</label>
                                <div id="strategyInfo" class="alert alert-info py-2 mb-0">
                                    <small>Loading strategy information...</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Performance:</label>
                                <div id="performanceMetrics" class="text-muted">
                                    <small>No recent classifications</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Input Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-edit me-2"></i>Content Input</h5>
                    </div>
                    <div class="card-body">
                        <!-- Child Selection -->
                        <div class="mb-3">
                            <label class="form-label">Test for Child Profile</label>
                            <select id="childSelect" class="form-select">
                                <option value="">No specific child (adult view)</option>
                                {% for child in children %}
                                <option value="{{ child.id }}">{{ child.name }} ({{ child.age }} years old)</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Content Input (Primary Section) -->
                        <div class="mb-4">
                            <label for="contentInput" class="form-label">
                                <i class="fas fa-edit me-2"></i><strong>Enter Your Content to Analyze</strong>
                            </label>
                            <textarea id="contentInput" class="form-control" rows="10" 
                                    placeholder="Type or paste any content here for AI safety analysis...

Examples you can try:
‚Ä¢ Social media posts or comments
‚Ä¢ News articles or blog posts  
‚Ä¢ Educational content for children
‚Ä¢ User-generated content from forums
‚Ä¢ Product descriptions or reviews
‚Ä¢ Any text you want to check for safety and appropriateness

The AI will analyze for:
‚úì Safety and age-appropriateness
‚úì Educational value and learning potential
‚úì Political bias and viewpoint balance
‚úì Source credibility and misinformation risk"></textarea>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Privacy Note:</strong> All analysis happens locally on your device. No content is sent to external services.
                            </div>
                        </div>

                        <!-- Quick Test Samples (Secondary) -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <label class="form-label mb-0 me-2">Or Try Quick Test Samples:</label>
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#sampleButtons" aria-expanded="false">
                                    <i class="fas fa-chevron-down me-1"></i>Show Samples
                                </button>
                            </div>
                            <div class="collapse" id="sampleButtons">
                                <div class="row g-2">
                                    {% for category, content in sample_content.items() %}
                                    <div class="col-md-6">
                                        <button class="btn btn-outline-secondary btn-sm w-100 sample-btn" onclick="loadSample('{{ category }}', this)">
                                            <i class="fas fa-file-text me-1"></i>{{ content.title }}
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="form-text mt-2">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    These samples demonstrate different content types and complexity levels.
                                </div>
                            </div>
                        </div>

                        <!-- Content Actions -->
                        <div class="d-flex gap-2 mb-3">
                            <button id="clearBtn" class="btn btn-outline-secondary" onclick="clearContent()">
                                <i class="fas fa-eraser me-2"></i>Clear
                            </button>
                            <button id="pasteBtn" class="btn btn-outline-secondary" onclick="pasteFromClipboard()">
                                <i class="fas fa-clipboard me-2"></i>Paste
                            </button>
                            <div class="flex-grow-1"></div>
                            <small class="text-muted align-self-center" id="charCount">0 characters</small>
                        </div>

                        <!-- Analyze Button -->
                        <button id="analyzeBtn" class="btn btn-primary btn-lg w-100" onclick="analyzeContent()">
                            <i class="fas fa-brain me-2"></i>Analyze with AI
                        </button>
                        
                        <div id="loading" class="loading text-center mt-2">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Analyzing...</span>
                            </div>
                            <p class="mt-2">AI analyzing content...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>Classification Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="resultsContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                <p>Results will appear here after content analysis</p>
                                <small>The AI will analyze safety, educational value, and viewpoint</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sampleContent = {{ sample_content | tojsonfilter }};

        function loadSample(category, buttonElement) {
            if (sampleContent[category]) {
                // Load the sample content
                document.getElementById('contentInput').value = sampleContent[category].content;
                
                // Clear previous results
                clearResults();
                
                // Update button highlighting
                updateSampleButtonHighlight(buttonElement);
                
                // Show feedback that sample was loaded
                showSampleLoadedFeedback(category);
            }
        }
        
        function clearResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            if (resultsContainer) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <p>Results will appear here after content analysis</p>
                        <small>Select a sample above or enter your own content, then click "Analyze with AI"</small>
                    </div>
                `;
            }
        }
        
        function updateSampleButtonHighlight(activeButton) {
            // Remove active class from all sample buttons
            document.querySelectorAll('.sample-btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'active');
                btn.classList.add('btn-outline-primary');
            });
            
            // Add active class to the clicked button
            if (activeButton) {
                activeButton.classList.remove('btn-outline-primary');
                activeButton.classList.add('btn-primary', 'active');
            }
        }
        
        function showSampleLoadedFeedback(category) {
            const categoryName = sampleContent[category]?.title || category;
            
            // Show a brief toast notification
            const toast = document.createElement('div');
            toast.className = 'toast position-fixed top-0 end-0 m-3';
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="toast-header bg-info text-white">
                    <i class="fas fa-file-text me-2"></i>
                    <strong class="me-auto">Sample Loaded</strong>
                </div>
                <div class="toast-body">
                    Loaded: ${categoryName}
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto-remove toast after 2 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 2000);
        }

        // Performance tracking
        let performanceHistory = [];
        
        // Strategy management functions
        async function loadCurrentStrategy() {
            try {
                const response = await fetch('/api/strategy');
                const data = await response.json();
                
                if (data.current_strategy) {
                    const strategySelect = document.getElementById('strategySelect');
                    const strategyInfo = document.getElementById('strategyInfo');
                    
                    strategySelect.value = data.current_strategy.strategy_type;
                    
                    const descriptions = {
                        'hybrid': 'Intelligently switches between fast filters and LLM reasoning based on content complexity',
                        'multi_layer': 'Uses fast rule-based filters ‚Üí specialized AI ‚Üí LLM only for edge cases (production-optimized)',
                        'llm_only': 'Full LLM analysis with comprehensive reasoning (best for AI demos and complex content)'
                    };
                    
                    const colors = {
                        'hybrid': 'alert-primary',
                        'multi_layer': 'alert-success', 
                        'llm_only': 'alert-warning'
                    };
                    
                    strategyInfo.className = `alert py-2 mb-0 ${colors[data.current_strategy.strategy_type]}`;
                    strategyInfo.innerHTML = `<small><strong>${data.current_strategy.strategy_name}:</strong> ${descriptions[data.current_strategy.strategy_type]}</small>`;
                    
                    updatePerformanceDisplay();
                }
            } catch (error) {
                console.error('Failed to load current strategy:', error);
                document.getElementById('strategyInfo').innerHTML = '<small class="text-danger">Error loading strategy info</small>';
            }
        }
        
        function updatePerformanceDisplay() {
            const performanceDiv = document.getElementById('performanceMetrics');
            
            if (performanceHistory.length === 0) {
                performanceDiv.innerHTML = '<small class="text-muted">No classifications yet</small>';
                return;
            }
            
            const recent = performanceHistory.slice(-5);
            const avgTime = recent.reduce((sum, p) => sum + p.time, 0) / recent.length;
            const totalClassifications = performanceHistory.length;
            
            performanceDiv.innerHTML = `
                <small>
                    <div><strong>${totalClassifications}</strong> classifications</div>
                    <div>Avg: <strong>${avgTime.toFixed(1)}s</strong></div>
                    <div class="text-success">Last: <strong>${recent[recent.length - 1]?.time.toFixed(1)}s</strong></div>
                </small>
            `;
        }
        
        async function switchStrategy() {
            const newStrategy = document.getElementById('strategySelect').value;
            const strategyInfo = document.getElementById('strategyInfo');
            const performanceDiv = document.getElementById('performanceMetrics');
            
            strategyInfo.innerHTML = '<small class="text-warning"><i class="fas fa-spinner fa-spin me-1"></i>Switching strategy...</small>';
            performanceDiv.innerHTML = '<small class="text-muted">Strategy switching...</small>';
            
            try {
                const response = await fetch('/api/strategy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ strategy: newStrategy })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Clear performance history when switching strategies
                    performanceHistory = [];
                    
                    // Show success notification
                    const toast = document.createElement('div');
                    toast.className = 'toast position-fixed top-0 end-0 m-3';
                    toast.innerHTML = `
                        <div class="toast-header bg-success text-white">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong class="me-auto">Strategy Switched</strong>
                        </div>
                        <div class="toast-body">
                            Switched from ${data.old_strategy} to ${newStrategy}
                        </div>
                    `;
                    document.body.appendChild(toast);
                    
                    // Auto-remove toast after 3 seconds
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 3000);
                    
                    // Reload strategy info
                    await loadCurrentStrategy();
                    
                    console.log('Strategy switched:', data.message);
                } else {
                    strategyInfo.innerHTML = '<small class="text-danger">Error switching strategy</small>';
                    console.error('Strategy switch failed:', data.error);
                }
            } catch (error) {
                strategyInfo.innerHTML = '<small class="text-danger">Error switching strategy</small>';
                console.error('Strategy switch error:', error);
            }
        }

        async function analyzeContent() {
            const content = document.getElementById('contentInput').value.trim();
            if (!content) {
                alert('Please enter content to analyze');
                return;
            }

            const childId = document.getElementById('childSelect').value;

            // Show loading
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            
            // Track start time for performance monitoring
            const startTime = Date.now();

            try {
                const response = await fetch('/api/classify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, childId })
                });

                const result = await response.json();
                
                // Track performance
                const endTime = Date.now();
                const processingTime = (endTime - startTime) / 1000;
                performanceHistory.push({
                    time: processingTime,
                    strategy: result.strategy_info?.strategy_type || 'unknown',
                    recommendation: result.recommendation
                });
                
                // Update performance display
                updatePerformanceDisplay();
                
                displayResults(result);

            } catch (error) {
                console.error('Error:', error);
                displayError(error.message);
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayResults(result) {
            const container = document.getElementById('resultsContainer');
            
            if (result.error) {
                displayError(result.error);
                return;
            }

            const safety = result.safety || {};
            const educational = result.educational || {};
            const viewpoint = result.viewpoint || {};

            const recommendationClass = 
                result.recommendation === 'allow' ? 'recommendation-allow' :
                result.recommendation === 'caution' ? 'recommendation-caution' : 'recommendation-block';

            container.innerHTML = `
                <!-- Strategy & Performance Info -->
                <div class="alert alert-dark mb-3">
                    <div class="row">
                        <div class="col-md-8">
                            <h6><i class="fas fa-cogs me-2"></i>Strategy Used: ${result.model || 'Unknown'}</h6>
                            <small>
                                Processing Time: <strong>${result.processing_time?.toFixed(2) || 'N/A'}s</strong> |
                                Confidence: <strong>${(result.confidence * 100)?.toFixed(1) || 'N/A'}%</strong>
                                ${result.curation_metadata?.baml_used ? ' | <span class="badge bg-success">BAML AI</span>' : ' | <span class="badge bg-secondary">Mock</span>'}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                Strategy: <strong>${result.strategy_info?.strategy_type || 'Unknown'}</strong><br>
                                ${result.curation_metadata?.engine_strategy ? `Engine: ${result.curation_metadata.engine_strategy}` : ''}
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Overall Recommendation -->
                <div class="alert ${recommendationClass} mb-3">
                    <h6><i class="fas fa-thumbs-${result.recommendation === 'allow' ? 'up' : result.recommendation === 'caution' ? 'sideways' : 'down'} me-2"></i>
                    Recommendation: ${result.recommendation.toUpperCase()}</h6>
                    <p class="mb-1">${safety.reasoning || 'AI analysis completed'}</p>
                    <small>Confidence: ${(result.confidence * 100).toFixed(1)}%</small>
                </div>

                <!-- Safety Analysis -->
                <div class="mb-3">
                    <h6><i class="fas fa-shield-alt me-2"></i>Safety Analysis</h6>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 mb-1 ${safety.safety_score > 0.7 ? 'text-success' : safety.safety_score > 0.4 ? 'text-warning' : 'text-danger'}">
                                    ${(safety.safety_score * 100).toFixed(1)}%
                                </div>
                                <small class="text-muted">Safety Score</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h6 mb-1">${safety.age_appropriate || 'All ages'}</div>
                                <small class="text-muted">Age Rating</small>
                            </div>
                        </div>
                    </div>
                    ${safety.warnings && safety.warnings.length > 0 ? `
                    <div class="mt-2">
                        <small><strong>Warnings:</strong></small>
                        <div class="mt-1">
                            ${safety.warnings.map(w => `<span class="badge bg-warning me-1">${w}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- Educational Analysis -->
                <div class="mb-3">
                    <h6><i class="fas fa-graduation-cap me-2"></i>Educational Value</h6>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 mb-1 ${educational.score > 0.7 ? 'text-success' : educational.score > 0.4 ? 'text-warning' : 'text-secondary'}">
                                    ${(educational.score * 100).toFixed(1)}%
                                </div>
                                <small class="text-muted">Educational Score</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h6 mb-1">${educational.cognitive_level || 'Basic'}</div>
                                <small class="text-muted">Cognitive Level</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Viewpoint Analysis -->
                <div class="mb-3">
                    <h6><i class="fas fa-balance-scale me-2"></i>Viewpoint Analysis</h6>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h6 mb-1">${viewpoint.political_leaning || 'Neutral'}</div>
                                <small class="text-muted">Political Leaning</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 mb-1 ${viewpoint.bias_score < 0.3 ? 'text-success' : viewpoint.bias_score < 0.6 ? 'text-warning' : 'text-danger'}">
                                    ${(viewpoint.bias_score * 100).toFixed(1)}%
                                </div>
                                <small class="text-muted">Bias Score</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Info -->
                <div class="text-center mt-3 pt-2 border-top">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>Processed in ${result.processing_time}s
                        <span class="mx-2">‚Ä¢</span>
                        <i class="fas fa-robot me-1"></i>Model: ${result.model}
                    </small>
                </div>
            `;
        }

        function displayError(error) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Analysis Error</h6>
                    <p class="mb-0">${error}</p>
                </div>
            `;
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Load current strategy on page load
            loadCurrentStrategy();
            
            // Add strategy change listener
            document.getElementById('strategySelect').addEventListener('change', switchStrategy);
            
            // Clear results when user manually edits content
            const contentInput = document.getElementById('contentInput');
            if (contentInput) {
                contentInput.addEventListener('input', function() {
                    // Clear button highlighting when user types manually
                    updateSampleButtonHighlight(null);
                    
                    // Only clear results if there are existing results
                    const resultsContainer = document.getElementById('resultsContainer');
                    if (resultsContainer && resultsContainer.innerHTML.includes('alert')) {
                        clearResults();
                    }
                    
                    // Update character count
                    updateCharCount();
                });
                
                // Initial character count
                updateCharCount();
            }
        }
        
        function clearContent() {
            document.getElementById('contentInput').value = '';
            clearResults();
            updateSampleButtonHighlight(null);
            updateCharCount();
        }
        
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    document.getElementById('contentInput').value = text;
                    clearResults();
                    updateSampleButtonHighlight(null);
                    updateCharCount();
                    
                    // Show success feedback
                    showToast('Content pasted successfully!', 'success');
                }
            } catch (err) {
                // Fallback for browsers that don't support clipboard API
                showToast('Please paste manually using Ctrl+V (or Cmd+V on Mac)', 'info');
            }
        }
        
        function updateCharCount() {
            const content = document.getElementById('contentInput').value;
            const count = content.length;
            const charCountElement = document.getElementById('charCount');
            
            if (charCountElement) {
                charCountElement.textContent = `${count.toLocaleString()} characters`;
                
                // Add visual feedback for content length
                if (count === 0) {
                    charCountElement.className = 'text-muted align-self-center';
                } else if (count < 100) {
                    charCountElement.className = 'text-info align-self-center';
                } else if (count < 1000) {
                    charCountElement.className = 'text-success align-self-center';
                } else {
                    charCountElement.className = 'text-warning align-self-center';
                }
            }
        }
        
        function showToast(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `toast position-fixed top-0 end-0 m-3 text-bg-${type}`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="toast-header">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong class="me-auto">AI Curation Engine</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${message}</div>
            `;
            
            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove from DOM after hiding
            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toast);
            });
        }
            
            console.log('Page initialized with pluggable curation engine');
        });
    </script>
</body>
</html>
    